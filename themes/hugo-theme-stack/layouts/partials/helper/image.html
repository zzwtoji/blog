{{ $result := dict "exists" false "permalink" nil "resource" nil "isDefault" false }}
{{ $imageField := default "image" .Context.Site.Params.featuredImageField }}
{{ $imageValue := index .Context.Params $imageField }}

{{ if $imageValue }}
<!-- If page has `image` field set -->
{{ $result = merge $result (dict "exists" true) }}
{{ $url := urls.Parse $imageValue }}

{{ if or (eq $url.Scheme "http") (eq $url.Scheme "https") }}
<!-- Is an external image -->
{{ $result = merge $result (dict "permalink" $imageValue) }}
{{ else }}
{{ $pageResourceImage := .Context.Resources.GetMatch (printf "%s" ($imageValue | safeURL)) }}

{{ if $pageResourceImage }}
<!-- If image is found under page bundle -->
{{ $result = merge $result (dict "permalink" $pageResourceImage.RelPermalink) }}

<!-- Disable SVG image processing, not supported by Hugo -->
{{ if ne (path.Ext $imageValue) ".svg" }}
{{ $result = merge $result (dict "resource" $pageResourceImage) }}
{{ end }}
{{ else }}
<!-- Can not find the image under page bundle. Could be a relative linked image -->
{{ $result = merge $result (dict "permalink" (relURL $imageValue)) }}
{{ end }}

{{ end }}

{{ else if and (ne .Type nil) (index .Context.Site.Params.defaultImage .Type) }}
<!-- Type arg is set, check for defaultImage setting -->
{{ $defaultImageSetting := index .Context.Site.Params.defaultImage .Type }}

{{ if $defaultImageSetting.enabled }}
{{ $result = merge $result (dict "isDefault" true) }}
{{ $result = merge $result (dict "exists" true) }}

{{ if $defaultImageSetting.local }}
{{ $siteResourceImage := resources.GetMatch (printf "%s" ($defaultImageSetting.src | safeURL)) }}

{{ if $siteResourceImage }}
<!-- Try search image under site's assets folder -->
{{ $result = merge $result (dict "permalink" $siteResourceImage.RelPermalink) }}
{{ $result = merge $result (dict "resource" $siteResourceImage) }}
{{ else }}
<!-- Can not find the image -->
{{ errorf "Failed loading image: %q" $defaultImageSetting.src }}
{{ $result = merge $result (dict "exists" false) }}
{{ end }}

{{ else }}
<!-- External image -->
{{ $result = merge $result (dict "permalink" (relURL $defaultImageSetting.src)) }}
{{ end }}

{{ end }}

{{ end }}

{{/*
If still no image found, try a taxonomy fallback: for taxonomy pages (terms)
use the first page in the term that has an image as the term image.
*/}}
{{ if not $result.exists }}
{{/* Determine if context is a taxonomy term */}}
{{ $isTaxonomy := or (eq .Context.Kind "taxonomy") (eq .Context.Kind "taxonomyTerm") }}
{{ if not $isTaxonomy }}
{{/* some templates pass a taxonomy context under different kinds, try checking .Type */}}
{{ if in (slice "taxonomy" "section" "term") (printf "%s" .Context.Type) }}
{{ $isTaxonomy = true }}
{{ end }}
{{ end }}

{{ if $isTaxonomy }}
{{ $pages := .Context.Pages }}
{{ if not $pages }}
{{/* try to load pages for taxonomy term by falling back to Site.GetPage */}}
{{ with .Context.Site }}
{{ $t := .GetPage (printf "taxonomyTerm/%s" .Context.Title) }}
{{ if $t }}
{{ $pages = $t.Pages }}
{{ end }}
{{ end }}
{{ end }}

{{ if $pages }}
{{ range $i, $p := $pages }}
{{ $imgVal := index $p.Params $imageField }}
{{ if $imgVal }}
{{ $url := urls.Parse $imgVal }}
{{ if or (eq $url.Scheme "http") (eq $url.Scheme "https") }}
{{ $result = merge $result (dict "exists" true "permalink" $imgVal) }}
{{ break }}
{{ else }}
{{ $pr := $p.Resources.GetMatch (printf "%s" ($imgVal | safeURL)) }}
{{ if $pr }}
{{ $result = merge $result (dict "exists" true "permalink" $pr.RelPermalink "resource" $pr) }}
{{ break }}
{{ else }}
{{ $result = merge $result (dict "exists" true "permalink" (relURL $imgVal)) }}
{{ break }}
{{ end }}
{{ end }}
{{ end }}
{{ end }}
{{ end }}
{{ end }}
{{ end }}

{{ return $result }}